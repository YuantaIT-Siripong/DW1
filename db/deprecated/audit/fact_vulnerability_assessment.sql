-- ======================================================================
-- Vulnerability Assessment Event Fact
-- One row per vulnerability classification event for an investment profile.
-- Conforms to Audit Artifacts Standard (docs/audit/audit_artifacts_standard.md)
-- ======================================================================

CREATE TABLE IF NOT EXISTS fact.fact_vulnerability_assessment (
  -- Surrogate key
  vulnerability_assessment_sk   BIGINT GENERATED ALWAYS AS IDENTITY PRIMARY KEY,
  
  -- Business keys
  investment_profile_id         VARCHAR(50) NOT NULL,
  assessment_ts                 TIMESTAMP(6) NOT NULL,
  
  -- Version linkage
  investment_profile_version_sk BIGINT,
  
  -- Assessment outcome
  vulnerable_flag               BOOLEAN NOT NULL,
  vulnerability_reason_code     VARCHAR(100),  -- LOW_FINANCIAL_LITERACY, AGE_RELATED, HEALTH_IMPAIRMENT, LANGUAGE_BARRIER, UNKNOWN
  
  -- Assessment details
  assessment_method             VARCHAR(100) NOT NULL,  -- QUESTIONNAIRE, SUPERVISOR_REVIEW, COMPLAINT_TRIGGERED, PERIODIC_REVIEW
  assessor_id                   VARCHAR(100) NOT NULL DEFAULT 'SYSTEM',
  assessor_role                 VARCHAR(100) NOT NULL,  -- SUPERVISOR, COMPLIANCE_OFFICER, RELATIONSHIP_MANAGER, SYSTEM
  assessment_notes              TEXT,
  
  -- Status tracking
  previous_vulnerability_flag   BOOLEAN,
  status_change_flag            BOOLEAN NOT NULL DEFAULT FALSE,
  next_review_due_ts            TIMESTAMP(6),
  
  -- Event tracking (per standard)
  event_detected_ts             TIMESTAMP(6) NOT NULL,
  actor_id                      VARCHAR(100) NOT NULL DEFAULT 'SYSTEM',
  actor_type                    VARCHAR(50) NOT NULL DEFAULT 'HUMAN',
  event_source_system           VARCHAR(100) NOT NULL,
  rationale_code                VARCHAR(100) NOT NULL DEFAULT 'INITIAL_ASSESSMENT',
  
  -- Event hash (per standard)
  event_hash                    VARCHAR(64) NOT NULL DEFAULT '__PENDING__',
  event_hash_status             VARCHAR(20) NOT NULL DEFAULT 'PENDING',
  
  -- Audit metadata
  load_ts                       TIMESTAMP(6) NOT NULL DEFAULT CURRENT_TIMESTAMP,
  
  -- Foreign keys (nullable for early events; backfill job will populate)
  CONSTRAINT fk_investment_profile_version FOREIGN KEY (investment_profile_version_sk) 
    REFERENCES dim.dim_investment_profile_version(investment_profile_version_sk),
  
  -- Integrity constraints
  CONSTRAINT ck_vulnerable_reason CHECK (
    (vulnerable_flag = TRUE AND vulnerability_reason_code IS NOT NULL)
    OR (vulnerable_flag = FALSE AND vulnerability_reason_code IS NULL)
  ),
  CONSTRAINT ck_status_change CHECK (
    status_change_flag = FALSE OR (status_change_flag = TRUE AND previous_vulnerability_flag IS NOT NULL)
  ),
  CONSTRAINT ck_event_hash_status CHECK (
    (event_hash_status = 'PENDING' AND event_hash = '__PENDING__')
    OR (event_hash_status = 'GENERATED' AND event_hash != '__PENDING__' AND LENGTH(event_hash) = 64)
  ),
  CONSTRAINT ck_chronology CHECK (
    event_detected_ts >= assessment_ts OR rationale_code = 'CORRECTIVE_ACTION'
  ),
  CONSTRAINT ck_assessment_method CHECK (
    assessment_method IN ('QUESTIONNAIRE', 'SUPERVISOR_REVIEW', 'COMPLAINT_TRIGGERED', 'PERIODIC_REVIEW')
  ),
  CONSTRAINT ck_assessor_role CHECK (
    assessor_role IN ('SUPERVISOR', 'COMPLIANCE_OFFICER', 'RELATIONSHIP_MANAGER', 'SYSTEM')
  ),
  CONSTRAINT ck_actor_type CHECK (
    actor_type IN ('HUMAN', 'SYSTEM', 'BATCH_JOB')
  ),
  
  -- Uniqueness constraint
  CONSTRAINT uq_vulnerability_assessment_profile_ts UNIQUE (investment_profile_id, assessment_ts)
);

-- Indexes
CREATE INDEX idx_vulnerability_profile_time 
  ON fact.fact_vulnerability_assessment(investment_profile_id, assessment_ts);

CREATE INDEX idx_vulnerability_version 
  ON fact.fact_vulnerability_assessment(investment_profile_version_sk);

CREATE INDEX idx_vulnerability_next_review 
  ON fact.fact_vulnerability_assessment(next_review_due_ts) 
  WHERE next_review_due_ts IS NOT NULL;

CREATE INDEX idx_vulnerability_event_hash_status 
  ON fact.fact_vulnerability_assessment(event_hash_status) 
  WHERE event_hash_status = 'PENDING';

CREATE INDEX idx_vulnerability_flag_status 
  ON fact.fact_vulnerability_assessment(vulnerable_flag, status_change_flag);

-- Table comment
COMMENT ON TABLE fact.fact_vulnerability_assessment IS 
'Audit event fact capturing vulnerability classification events for investment profiles. Documents assessor, reason, and status changes for regulatory oversight. Conforms to Audit Artifacts Standard (ADR-AUDIT-001).';

-- Column comments
COMMENT ON COLUMN fact.fact_vulnerability_assessment.vulnerability_assessment_sk IS 
'Surrogate identifier for vulnerability assessment event (auto-generated)';

COMMENT ON COLUMN fact.fact_vulnerability_assessment.investment_profile_id IS 
'Investment profile identifier (stable across versions)';

COMMENT ON COLUMN fact.fact_vulnerability_assessment.assessment_ts IS 
'Business-effective timestamp when vulnerability assessment was conducted';

COMMENT ON COLUMN fact.fact_vulnerability_assessment.investment_profile_version_sk IS 
'Foreign key to investment profile version resulting from assessment (nullable for early events)';

COMMENT ON COLUMN fact.fact_vulnerability_assessment.vulnerable_flag IS 
'Assessment outcome: true = vulnerable investor, false = not vulnerable';

COMMENT ON COLUMN fact.fact_vulnerability_assessment.vulnerability_reason_code IS 
'Reason code if vulnerable: LOW_FINANCIAL_LITERACY, AGE_RELATED, HEALTH_IMPAIRMENT, LANGUAGE_BARRIER, UNKNOWN';

COMMENT ON COLUMN fact.fact_vulnerability_assessment.assessment_method IS 
'Assessment method: QUESTIONNAIRE, SUPERVISOR_REVIEW, COMPLAINT_TRIGGERED, PERIODIC_REVIEW';

COMMENT ON COLUMN fact.fact_vulnerability_assessment.assessor_id IS 
'Identifier of assessor (supervisor, compliance officer, or SYSTEM for automated)';

COMMENT ON COLUMN fact.fact_vulnerability_assessment.assessor_role IS 
'Role: SUPERVISOR, COMPLIANCE_OFFICER, RELATIONSHIP_MANAGER, SYSTEM';

COMMENT ON COLUMN fact.fact_vulnerability_assessment.status_change_flag IS 
'True if vulnerability status changed from previous assessment';

COMMENT ON COLUMN fact.fact_vulnerability_assessment.event_hash IS 
'SHA256 hash of event content (default __PENDING__ until hash generation job runs)';

COMMENT ON COLUMN fact.fact_vulnerability_assessment.event_hash_status IS 
'Hash generation status: PENDING (awaiting job) or GENERATED (hash computed)';
