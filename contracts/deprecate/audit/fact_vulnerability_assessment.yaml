entity_name: fact_vulnerability_assessment
domain: investment
table_type: fact_audit
grain_description: One row per vulnerability classification event for an investment profile (captures assessor, reason, and effective timestamp).
primary_keys:
  - vulnerability_assessment_sk
surrogate_keys:
  - vulnerability_assessment_sk
natural_keys:
  - investment_profile_id
  - assessment_ts
foreign_keys:
  - column: investment_profile_version_sk
    references: dim_investment_profile_version.investment_profile_version_sk
    nullable: true
    description: Version surrogate key created by this assessment; nullable for early events
attributes:
  - name: vulnerability_assessment_sk
    datatype: bigint
    business_definition: Surrogate identifier for vulnerability assessment event (auto-generated)
    constraints: "PRIMARY KEY, GENERATED ALWAYS AS IDENTITY"
  - name: investment_profile_id
    datatype: string
    business_definition: Investment profile identifier (stable across versions)
    constraints: "NOT NULL"
  - name: investment_profile_version_sk
    datatype: bigint
    business_definition: Foreign key to investment profile version resulting from assessment
    constraints: "NULLABLE"
  - name: assessment_ts
    datatype: timestamp
    business_definition: Business-effective timestamp when vulnerability assessment was conducted
    constraints: "NOT NULL"
  - name: vulnerable_flag
    datatype: boolean
    business_definition: Assessment outcome (true = vulnerable investor, false = not vulnerable)
    constraints: "NOT NULL"
  - name: vulnerability_reason_code
    datatype: string
    business_definition: Reason code if vulnerable (LOW_FINANCIAL_LITERACY, AGE_RELATED, HEALTH_IMPAIRMENT, LANGUAGE_BARRIER, UNKNOWN)
    constraints: "NULLABLE"
  - name: assessment_method
    datatype: string
    business_definition: Assessment method (QUESTIONNAIRE, SUPERVISOR_REVIEW, COMPLAINT_TRIGGERED, PERIODIC_REVIEW)
    constraints: "NOT NULL"
  - name: assessor_id
    datatype: string
    business_definition: Identifier of assessor (supervisor, compliance officer, or SYSTEM for automated)
    constraints: "NOT NULL DEFAULT 'SYSTEM'"
  - name: assessor_role
    datatype: string
    business_definition: Role of assessor (SUPERVISOR, COMPLIANCE_OFFICER, RELATIONSHIP_MANAGER, SYSTEM)
    constraints: "NOT NULL"
  - name: event_detected_ts
    datatype: timestamp
    business_definition: System timestamp when assessment event was detected/ingested
    constraints: "NOT NULL"
  - name: actor_id
    datatype: string
    business_definition: User identifier performing assessment (typically same as assessor_id)
    constraints: "NOT NULL DEFAULT 'SYSTEM'"
  - name: actor_type
    datatype: string
    business_definition: Actor type (HUMAN, SYSTEM, BATCH_JOB)
    constraints: "NOT NULL DEFAULT 'HUMAN'"
  - name: event_source_system
    datatype: string
    business_definition: Source system code (e.g., COMPLIANCE_PORTAL, CRM, SUITABILITY_ENGINE)
    constraints: "NOT NULL"
  - name: rationale_code
    datatype: string
    business_definition: Reason code for assessment (INITIAL_ASSESSMENT, PERIODIC_REVIEW, COMPLAINT_INVESTIGATION, CORRECTIVE_ACTION)
    constraints: "NOT NULL DEFAULT 'INITIAL_ASSESSMENT'"
  - name: assessment_notes
    datatype: text
    business_definition: Freeform notes from assessor (redacted for privacy; summary only)
    constraints: "NULLABLE"
  - name: previous_vulnerability_flag
    datatype: boolean
    business_definition: Previous vulnerability status (null if initial assessment)
    constraints: "NULLABLE"
  - name: status_change_flag
    datatype: boolean
    business_definition: True if vulnerability status changed from previous assessment
    constraints: "NOT NULL DEFAULT FALSE"
  - name: next_review_due_ts
    datatype: timestamp
    business_definition: Scheduled next assessment timestamp (e.g., 6 months if vulnerable)
    constraints: "NULLABLE"
  - name: event_hash
    datatype: string
    business_definition: SHA256 hash of event content (default __PENDING__ until hash generation job runs)
    constraints: "NOT NULL DEFAULT '__PENDING__', LENGTH = 64 OR = '__PENDING__'"
  - name: event_hash_status
    datatype: string
    business_definition: Hash generation status (PENDING, GENERATED)
    constraints: "NOT NULL DEFAULT 'PENDING'"
  - name: load_ts
    datatype: timestamp
    business_definition: ETL ingestion timestamp
    constraints: "NOT NULL DEFAULT CURRENT_TIMESTAMP"
data_quality_rules:
  - "UNIQUE (investment_profile_id, assessment_ts) - one assessment per profile per timestamp"
  - "vulnerable_flag = TRUE implies vulnerability_reason_code IS NOT NULL - must provide reason if vulnerable"
  - "vulnerable_flag = FALSE implies vulnerability_reason_code IS NULL - no reason code if not vulnerable"
  - "event_detected_ts >= assessment_ts OR rationale_code = 'CORRECTIVE_ACTION' - allow backdating only for corrections"
  - "event_hash_status = 'PENDING' AND event_hash = '__PENDING__' OR event_hash_status = 'GENERATED' AND LENGTH(event_hash) = 64"
  - "assessment_method IN ('QUESTIONNAIRE', 'SUPERVISOR_REVIEW', 'COMPLAINT_TRIGGERED', 'PERIODIC_REVIEW') - valid enumeration"
  - "assessor_role IN ('SUPERVISOR', 'COMPLIANCE_OFFICER', 'RELATIONSHIP_MANAGER', 'SYSTEM') - valid enumeration"
  - "actor_type IN ('HUMAN', 'SYSTEM', 'BATCH_JOB') - valid enumeration"
  - "status_change_flag = TRUE implies previous_vulnerability_flag IS NOT NULL - can only change from known state"
adr_refs:
  - ADR-AUDIT-001-audit-artifacts-standard.md
  - ADR-INV-001-investment-profile.md
open_questions:
  - "Retention period for assessment_notes (contains potentially sensitive information)?"
  - "Should vulnerability expiry be tracked (e.g., temporary health impairment)?"
sample_rows:
  - vulnerability_assessment_sk: 20001
    investment_profile_id: "IP-CODE-111111"
    investment_profile_version_sk: 5003
    assessment_ts: "2025-11-18T09:30:00Z"
    vulnerable_flag: true
    vulnerability_reason_code: "LOW_FINANCIAL_LITERACY"
    assessment_method: "QUESTIONNAIRE"
    assessor_id: "SUPERVISOR-001"
    assessor_role: "SUPERVISOR"
    event_detected_ts: "2025-11-18T09:32:00Z"
    actor_id: "SUPERVISOR-001"
    actor_type: "HUMAN"
    event_source_system: "COMPLIANCE_PORTAL"
    rationale_code: "INITIAL_ASSESSMENT"
    assessment_notes: "Client struggled with risk concept questions; requires simplified disclosures"
    previous_vulnerability_flag: null
    status_change_flag: false
    next_review_due_ts: "2026-05-18T00:00:00Z"
    event_hash: "__PENDING__"
    event_hash_status: "PENDING"
    load_ts: "2025-11-18T09:32:10Z"
  - vulnerability_assessment_sk: 20002
    investment_profile_id: "IP-CODE-111111"
    investment_profile_version_sk: 5010
    assessment_ts: "2026-05-19T10:00:00Z"
    vulnerable_flag: false
    vulnerability_reason_code: null
    assessment_method: "PERIODIC_REVIEW"
    assessor_id: "SUPERVISOR-001"
    assessor_role: "SUPERVISOR"
    event_detected_ts: "2026-05-19T10:02:00Z"
    actor_id: "SUPERVISOR-001"
    actor_type: "HUMAN"
    event_source_system: "COMPLIANCE_PORTAL"
    rationale_code: "PERIODIC_REVIEW"
    assessment_notes: "Client completed financial literacy training; reassessment shows improved understanding"
    previous_vulnerability_flag: true
    status_change_flag: true
    next_review_due_ts: "2027-05-19T00:00:00Z"
    event_hash: "b4c8d9e0f1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8"
    event_hash_status: "GENERATED"
    load_ts: "2026-05-19T10:02:05Z"
