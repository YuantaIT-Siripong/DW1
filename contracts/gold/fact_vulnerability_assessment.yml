entity_name: fact_vulnerability_assessment
domain: investment
table_type: fact_audit
layer: gold
grain_description:  One row per vulnerability assessment event. Tracks vulnerability classification changes, reason codes, assessment methods, and next review scheduling.

upstream_source:
  layer: bronze
  table_name: bronze.vulnerability_assessment_events
  transformation_type:  event_capture_and_audit_logging
  note: Captured from vulnerability assessment system

primary_keys:
  - vulnerability_assessment_id

surrogate_keys:
  - vulnerability_assessment_id

natural_keys:
  - investment_profile_id
  - assessment_ts

foreign_keys:
  - column: investment_profile_version_sk
    references: dim_investment_profile.investment_profile_version_sk
    description: Investment profile version created/updated by this assessment
    relationship: many_to_one
    nullable: false

attributes:
  # ===================================================================
  # SURROGATE KEY
  # ===================================================================
  
  - name: vulnerability_assessment_id
    datatype: BIGINT
    business_definition:  Surrogate identifier for the vulnerability assessment event (auto-increment)
    nullable: false
    primary_key:  true
    generation: auto_increment

  # ===================================================================
  # FOREIGN KEYS
  # ===================================================================
  
  - name: investment_profile_id
    datatype: VARCHAR(50)
    business_definition: Investment profile identifier being assessed
    nullable: false

  - name: investment_profile_version_sk
    datatype:  BIGINT
    business_definition:  Surrogate key of investment profile version created/updated by this assessment
    nullable: false
    foreign_key: true
    references: dim_investment_profile.investment_profile_version_sk

  - name: customer_id
    datatype: VARCHAR(50)
    business_definition: Customer identifier for convenience queries
    nullable: false

  - name:  customer_code
    datatype: VARCHAR(50)
    business_definition: Customer code if assessment at code level
    nullable: true

  # ===================================================================
  # ASSESSMENT DETAILS
  # ===================================================================
  
  - name: assessment_ts
    datatype: TIMESTAMP
    business_definition: UTC timestamp when vulnerability assessment was conducted
    nullable:  false
    note: Business-effective timestamp

  - name: assessment_type
    datatype: VARCHAR(50)
    business_definition: Type of assessment conducted
    nullable: false
    valid_values: [INITIAL, PERIODIC_REVIEW, TRIGGERED_BY_EVENT, COMPLAINT_INVESTIGATION, REGULATORY_REQUIREMENT]

  - name: assessment_method
    datatype: VARCHAR(50)
    business_definition: Method used for vulnerability assessment
    nullable: false
    valid_values: [QUESTIONNAIRE, INTERVIEW, BEHAVIORAL_ANALYSIS, REGULATORY_SCREENING, THIRD_PARTY_REPORT]

  - name: assessor_user_id
    datatype: VARCHAR(100)
    business_definition: User ID of person who conducted assessment
    nullable: false

  - name: assessor_role
    datatype: VARCHAR(100)
    business_definition: Role of assessor
    nullable: false
    valid_values: [COMPLIANCE_OFFICER, RELATIONSHIP_MANAGER, BRANCH_MANAGER, EXTERNAL_AUDITOR]

  # ===================================================================
  # VULNERABILITY STATUS
  # ===================================================================
  
  - name: previous_vulnerable_flag
    datatype: BOOLEAN
    business_definition:  Vulnerability flag before this assessment (NULL for initial)
    nullable: true

  - name: new_vulnerable_flag
    datatype: BOOLEAN
    business_definition: Vulnerability flag after this assessment
    nullable: false

  - name: previous_vulnerability_reason_code
    datatype: VARCHAR(50)
    business_definition:  Vulnerability reason code before assessment (NULL for initial)
    nullable: true
    enumeration_ref: enumerations/investment_vulnerability_reason.yaml

  - name: new_vulnerability_reason_code
    datatype: VARCHAR(50)
    business_definition: Vulnerability reason code after assessment
    nullable: true
    enumeration_ref: enumerations/investment_vulnerability_reason.yaml
    valid_values: [LOW_FINANCIAL_LITERACY, ELDERLY, DISABILITY, LIMITED_LANGUAGE_PROFICIENCY, LOW_INCOME, COGNITIVE_IMPAIRMENT, NONE, UNKNOWN]

  - name: status_change_type
    datatype: VARCHAR(50)
    business_definition: Type of vulnerability status change
    nullable: false
    valid_values: [INITIAL_CLASSIFICATION, BECAME_VULNERABLE, BECAME_NON_VULNERABLE, REASON_CODE_CHANGED, NO_CHANGE_CONFIRMED]

  # ===================================================================
  # ASSESSMENT FINDINGS
  # ===================================================================
  
  - name: assessment_score
    datatype: NUMERIC(5,2)
    business_definition: Vulnerability assessment score (0-100, higher = more vulnerable)
    nullable: true
    note: Scoring model specific to assessment method

  - name: risk_indicators_identified
    datatype: TEXT
    business_definition: JSON array of risk indicators identified
    nullable: true
    format: JSON array
    example: '["LIMITED_INVESTMENT_KNOWLEDGE","PRESSURE_FROM_FAMILY","RECENT_LOSS"]'

  - name: protective_factors_identified
    datatype: TEXT
    business_definition:  JSON array of protective factors identified
    nullable: true
    format: JSON array
    example: '["PROFESSIONAL_ADVISOR","FAMILY_SUPPORT","STABLE_INCOME"]'

  - name: assessment_notes
    datatype: TEXT
    business_definition:  Detailed notes from assessment
    nullable: true
    pii: true
    pii_category: assessment_notes

  - name: recommended_actions
    datatype: TEXT
    business_definition: Recommended protective actions
    nullable: true
    example: "Enhanced disclosure, cooling-off period, advisor consultation required"

  # ===================================================================
  # REVIEW SCHEDULING
  # ===================================================================
  
  - name: previous_next_review_due_ts
    datatype: TIMESTAMP
    business_definition: Previous scheduled review date (NULL for initial)
    nullable: true

  - name: new_next_review_due_ts
    datatype: TIMESTAMP
    business_definition: New scheduled review date after this assessment
    nullable: false
    note:  Accelerated to 6 months if vulnerable=TRUE

  - name: review_frequency_months
    datatype: INT
    business_definition: Review frequency in months
    nullable: false
    note: 6 months if vulnerable, 12 or 24 months otherwise

  # ===================================================================
  # REGULATORY COMPLIANCE
  # ===================================================================
  
  - name: regulatory_framework
    datatype: VARCHAR(100)
    business_definition:  Regulatory framework under which assessment conducted
    nullable: true
    example: "SEC Regulation Best Interest, FINRA Rule 2111"

  - name: compliance_checklist_version
    datatype: VARCHAR(50)
    business_definition: Version of compliance checklist used
    nullable: true

  - name: mandatory_disclosures_provided
    datatype:  BOOLEAN
    business_definition: TRUE if all mandatory disclosures were provided to customer
    nullable: false

  - name: customer_acknowledgement_received
    datatype: BOOLEAN
    business_definition: TRUE if customer acknowledged vulnerability classification
    nullable: false

  # ===================================================================
  # EVENT HASH
  # ===================================================================
  
  - name: event_hash
    datatype: VARCHAR(64)
    business_definition: SHA256 hash of event content for integrity verification
    nullable: false
    computation: SHA256(assessment_ts||investment_profile_id||new_vulnerable_flag||new_vulnerability_reason_code)

  # ===================================================================
  # AUDIT METADATA
  # ===================================================================
  
  - name: event_detected_ts
    datatype: TIMESTAMP
    business_definition: UTC timestamp when event was ingested into warehouse
    nullable:  false
    default: CURRENT_TIMESTAMP

  - name: load_ts
    datatype:  TIMESTAMP
    business_definition: UTC timestamp when record was loaded into Gold layer
    nullable: false
    default: CURRENT_TIMESTAMP
    etl_metadata: true

  - name: source_system
    datatype: VARCHAR(100)
    business_definition: Source system that generated assessment event
    nullable: false
    default: VULNERABILITY_ASSESSMENT_SYSTEM

  - name: etl_batch_id
    datatype:  BIGINT
    business_definition: ETL batch identifier for lineage
    nullable: true

materialization_strategy:
  approach: table
  reason: Audit trail - insert only, immutable
  refresh_pattern: append_on_event_capture
  append_only:  true

data_quality_rules: 
  - rule: no_duplicates
    description: No duplicate vulnerability_assessment_id
    
  - rule: fk_integrity
    description: investment_profile_version_sk must exist in dim_investment_profile
    
  - rule: review_date_future
    description: new_next_review_due_ts > assessment_ts
    
  - rule: vulnerable_requires_reason
    description: If new_vulnerable_flag=TRUE, then new_vulnerability_reason_code IS NOT NULL AND != 'NONE'
    
  - rule:  not_vulnerable_reason_none
    description: If new_vulnerable_flag=FALSE, then new_vulnerability_reason_code IN ('NONE', NULL)
    
  - rule: hash_integrity
    description: event_hash must be valid SHA256 format (64 hex characters)

indexes:
  - name: pk_vulnerability_assessment
    type: primary_key
    columns: [vulnerability_assessment_id]
    
  - name: idx_investment_profile_id
    type: non_unique
    columns: [investment_profile_id]
    description: Lookup all assessments for a profile
    
  - name: idx_customer_id
    type: non_unique
    columns: [customer_id]
    description: Lookup all assessments for a customer
    
  - name: idx_assessment_ts
    type: non_unique
    columns: [assessment_ts]
    description: Time-based queries
    
  - name: idx_vulnerable_flag
    type: non_unique
    columns: [new_vulnerable_flag, assessment_ts]
    description: Find vulnerability classifications
    
  - name: idx_next_review_due
    type: non_unique
    columns: [new_next_review_due_ts]
    description: Find overdue reviews
    
  - name: idx_version_sk
    type: non_unique
    columns: [investment_profile_version_sk]
    description: Link to specific version

adr_refs:
  - ADR-INV-001-investment-profile-scd2.md
  - ADR-AUDIT-001-audit-artifacts-standard.md

related_contracts:
  - contracts/gold/dim_investment_profile.yaml
  - contracts/gold/fact_investment_profile_audit.yaml

sample_rows:
  - vulnerability_assessment_id: 800001
    investment_profile_id: "IP-CODE-111111"
    investment_profile_version_sk: 500124
    customer_id: "CUST-12345"
    customer_code: "111111"
    assessment_ts: "2025-11-18T09:30:00Z"
    assessment_type: "PERIODIC_REVIEW"
    assessment_method:  "QUESTIONNAIRE"
    assessor_user_id: "compliance_officer_001"
    assessor_role: "COMPLIANCE_OFFICER"
    previous_vulnerable_flag: false
    new_vulnerable_flag: true
    previous_vulnerability_reason_code: "NONE"
    new_vulnerability_reason_code: "LOW_FINANCIAL_LITERACY"
    status_change_type: "BECAME_VULNERABLE"
    assessment_score: 68.50
    risk_indicators_identified:  '["LIMITED_INVESTMENT_KNOWLEDGE","PRESSURE_FROM_FAMILY"]'
    protective_factors_identified: '["FAMILY_SUPPORT"]'
    assessment_notes: "Customer demonstrated limited understanding of investment risks during review."
    recommended_actions: "Enhanced disclosure required, mandatory advisor consultation"
    previous_next_review_due_ts: "2026-11-18T00:00:00Z"
    new_next_review_due_ts: "2026-05-18T00:00:00Z"
    review_frequency_months: 6
    regulatory_framework: "SEC Regulation Best Interest"
    compliance_checklist_version: "VUL_ASSESS_v2.1"
    mandatory_disclosures_provided: true
    customer_acknowledgement_received: true
    event_hash: "9e2b8c3d..."
    event_detected_ts:  "2025-11-18T09:35:00Z"
    load_ts: "2025-11-18T10:00:00Z"
    source_system: "VULNERABILITY_ASSESSMENT_SYSTEM"
    etl_batch_id: 56789