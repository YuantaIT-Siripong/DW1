entity_name: bridge_customer_source_of_income
domain: customer
table_type:  bridge
layer: gold
grain_description: One row per source of income membership for each customer profile version.  Multi-valued relationship between profile versions and income sources.

upstream_source:
  layer: silver
  table_name: silver. customer_profile_standardized
  source_field: source_of_income_list
  transformation_type: parse_pipe_delimited_to_rows

primary_keys:
  - customer_profile_version_sk
  - source_of_income_code

foreign_keys:
  - column: customer_profile_version_sk
    references: dim_customer_profile.customer_profile_version_sk
    description: Link to specific profile version
    relationship: many_to_one

attributes:
  - name:  customer_profile_version_sk
    datatype: BIGINT
    business_definition: Surrogate key of the profile version this income source belongs to
    nullable: false
    primary_key: true
    source:  dim_customer_profile.customer_profile_version_sk

  - name: customer_id
    datatype: VARCHAR(50)
    business_definition: Denormalized stable customer identifier (for convenience queries)
    nullable: false
    source: dim_customer_profile.customer_id
    denormalized: true
    note:  Denormalized from dim for query performance

  - name: source_of_income_code
    datatype: VARCHAR(100)
    business_definition: Income source enumeration code
    nullable: false
    primary_key: true
    enumeration_ref: enumerations/customer_source_of_income. yaml
    valid_values: [SALARY, DIVIDEND, RENTAL, BUSINESS, PENSION, INVESTMENT, INHERITANCE, GIFT, OTHER, UNKNOWN]
    source:  Parsed from silver.customer_profile_standardized. source_of_income_list

  - name: load_ts
    datatype: TIMESTAMP
    business_definition: UTC timestamp when record was loaded into Gold layer
    nullable: false
    default: CURRENT_TIMESTAMP
    etl_metadata: true

set_membership_behavior: |
  Full set is re-materialized for each new profile version only when membership changes.
  Bridge rows are immutable once created (tied to specific profile version).
  
  ETL Process:
  1. Parse source_of_income_list from Silver (pipe-delimited string)
  2. Split by "|" delimiter
  3. Normalize each code: UPPER(TRIM)
  4. Create one bridge row per code for the given customer_profile_version_sk
  5. Compute set hash for validation

hash_dependency:
  parent_set_hash_column: source_of_income_set_hash
  computation_logic: |
    1. Retrieve all source_of_income_code values for given customer_profile_version_sk
    2. Normalize each code: UPPER(TRIM)
    3. Deduplicate (should not happen in well-formed data)
    4. Sort codes ascending alphabetically
    5. Join with "|" delimiter (empty set -> "")
    6. SHA256(joined_string) -> source_of_income_set_hash
    7.  Verify hash matches dim_customer_profile.source_of_income_set_hash
  
  example_sql:  |
    SELECT LOWER(ENCODE(SHA256(STRING_AGG(source_of_income_code, '|' ORDER BY source_of_income_code):: bytea), 'hex'))
    FROM bridge_customer_source_of_income
    WHERE customer_profile_version_sk = :version_sk;

materialization_strategy: 
  approach: table
  reason: Bridge table for multi-valued relationship
  refresh_pattern: insert_only_on_new_version
  note: Rows inserted only when dim_customer_profile gets new version with changed source_of_income_set_hash

data_quality_rules:
  - rule: no_duplicates
    description: No duplicate (customer_profile_version_sk, source_of_income_code) combinations
    
  - rule: valid_enumeration
    description: All source_of_income_code values must exist in enumeration file
    
  - rule: fk_integrity
    description: customer_profile_version_sk must exist in dim_customer_profile
    
  - rule: at_least_one_member
    description:  Each customer_profile_version_sk should have at least 1 source (recommended, not enforced)
    
  - rule: hash_consistency
    description:  Computed hash from bridge rows must match dim_customer_profile.source_of_income_set_hash

indexes:
  - name: pk_bridge_income_source
    type: primary_key
    columns: [customer_profile_version_sk, source_of_income_code]
    
  - name: idx_customer_id
    type: non_unique
    columns: [customer_id]
    description: Fast lookup by customer (all versions)
    
  - name: idx_source_code
    type: non_unique
    columns: [source_of_income_code]
    description:  Lookup by income source type

adr_refs:
  - ADR-002-multi-valued-sets-via-bridge.md
  - ADR-003-enumeration-with-other-pattern.md

sample_rows:
  - customer_profile_version_sk: 102938
    customer_id: "556677"
    source_of_income_code: "SALARY"
    load_ts: "2025-12-01T08:05:10Z"
    
  - customer_profile_version_sk: 102938
    customer_id: "556677"
    source_of_income_code:  "DIVIDEND"
    load_ts: "2025-12-01T08:05:10Z"

version:  1.0
last_updated: 2026-01-05
owner: Data Architecture Team