entity_name: dim_customer_investment_purpose_version
domain: customer
table_type: bridge
grain_description: One row per investment purpose membership for a profile version.
primary_keys:
  - profile_version_id
  - investment_purpose_code
foreign_keys:
  - column: profile_version_id
    references: dim_customer_profile.profile_version_id
  - column: investment_purpose_code
    references: dim_investment_purpose.investment_purpose_code
attributes:
  - name: profile_version_id
    datatype: integer
    business_definition: Link to historical profile version
  - name: customer_id
    datatype: string
    business_definition: Denormalized stable customer identity
  - name: investment_purpose_code
    datatype: string
    business_definition: Selected investment purpose code
  - name: primary_flag
    datatype: boolean
    business_definition: Indicates primary purpose (at most one TRUE per profile_version_id)
  - name: load_ts
    datatype: timestamp
    business_definition: Ingestion timestamp
set_membership_behavior: Full set re-materialized only when membership changes.
hash_dependency:
  parent_set_hash_column: investment_purpose_set_hash
  recomputation_logic: |
    SELECT SHA256(STRING_AGG(investment_purpose_code, '|' ORDER BY investment_purpose_code))
    FROM dim_customer_investment_purpose_version
    WHERE profile_version_id = :pv_id;
data_quality_rules:
  - "No duplicate (profile_version_id, investment_purpose_code)"
  - "All investment_purpose_code values valid in dim_investment_purpose"
  - "At most one primary_flag = TRUE per profile_version_id"
adr_refs:
  - ADR-002-multi-valued-sets.md
sample_rows:
  - profile_version_id: 10
    customer_id: C123456
    investment_purpose_code: RETIREMENT
    primary_flag: true
  - profile_version_id: 10
    customer_id: C123456
    investment_purpose_code: EDUCATION
    primary_flag: false
open_questions:
  - "Is primary_flag mandatory or optional?"